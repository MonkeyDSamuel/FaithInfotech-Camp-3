<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Test Lab Technician Dashboard</title>
  <link rel="stylesheet" href="css/staff.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
</head>
<body>
  <header>
    <div class="header-content">
      <h1><i class="fas fa-microscope"></i> Test Lab Technician Dashboard</h1>
      <nav>
        <ul>
          <li><button onclick="window.location.href='pages/labtech_dashboard.html'" class="nav-btn">
            <i class="fas fa-external-link-alt"></i> Open Dashboard
          </button></li>
          <li><button onclick="window.location.href='pages/staff_login.html'" class="nav-btn">
            <i class="fas fa-sign-in-alt"></i> Back to Login
          </button></li>
        </ul>
      </nav>
    </div>
  </header>

  <main>
    <div class="container">
             <div class="test-section">
         <h2><i class="fas fa-flask"></i> Test Data Management</h2>
         <p>This page allows you to manage the lab technician dashboard data. Tests and test reports are added directly through the dashboard interface.</p>
        
                 <div class="test-controls">
           <button onclick="loadSampleTests()" class="btn btn-secondary" disabled>
             <i class="fas fa-list"></i> No Preset Tests (Add via Dashboard)
           </button>
           <button onclick="loadSampleTestReports()" class="btn btn-secondary" disabled>
             <i class="fas fa-file-medical"></i> No Preset Reports (Add via Dashboard)
           </button>
           <button onclick="clearAllData()" class="btn btn-danger">
             <i class="fas fa-trash"></i> Clear All Data
           </button>
           <button onclick="checkLocalStorage()" class="btn btn-secondary">
             <i class="fas fa-database"></i> Check Local Storage
           </button>
         </div>
        
        <div class="test-status">
          <div id="testListStatus" class="status-card">
            <h3>Test List Data</h3>
            <p id="testListCount">No data loaded</p>
          </div>
          <div id="testReportStatus" class="status-card">
            <h3>Test Report Data</h3>
            <p id="testReportCount">No data loaded</p>
          </div>
        </div>
      </div>

      <div class="test-section">
        <h2><i class="fas fa-info-circle"></i> Dashboard Features</h2>
        <div class="features-grid">
                     <div class="feature-card">
             <h3><i class="fas fa-list"></i> Test List</h3>
             <ul>
               <li>Add new laboratory tests with details (no preset data)</li>
               <li>Edit existing test information</li>
               <li>Delete tests from the list</li>
               <li>Search tests by name</li>
               <li>Filter by category (Blood, Urine, Biochemistry, etc.)</li>
               <li>All data stored locally in browser</li>
             </ul>
           </div>
                     <div class="feature-card">
             <h3><i class="fas fa-file-medical"></i> Test Reports</h3>
             <ul>
               <li>Create new test reports with patient details (no preset data)</li>
               <li>Edit existing test reports</li>
               <li>Delete test reports</li>
               <li>Search by Patient ID</li>
               <li>Filter by status and date</li>
               <li>View detailed test results</li>
             </ul>
           </div>
          <div class="feature-card">
            <h3><i class="fas fa-history"></i> Previous Test Reports</h3>
            <ul>
              <li>View all completed and cancelled reports</li>
              <li>Search by Patient ID</li>
              <li>Filter by status and date range</li>
              <li>Print test reports</li>
              <li>Download reports as PDF</li>
              <li>Professional report formatting</li>
            </ul>
          </div>
        </div>
      </div>

      <div class="test-section">
        <h2><i class="fas fa-cogs"></i> Test Functions</h2>
        <div class="test-functions">
          <button onclick="testTestListCRUD()" class="btn btn-secondary">
            Test Test List CRUD
          </button>
          <button onclick="testTestReportCRUD()" class="btn btn-secondary">
            Test Test Report CRUD
          </button>
          <button onclick="testReportPrinting()" class="btn btn-secondary">
            Test Report Printing
          </button>
          <button onclick="exportData()" class="btn btn-secondary">
            Export Data
          </button>
        </div>
      </div>
    </div>
  </main>

  <script src="js/staff.js"></script>
  <script>
    // Test data constants
    const TEST_LIST_DATA_KEY = 'hospitalTestListData';
    const TEST_REPORT_DATA_KEY = 'hospitalTestReportData';

    // Sample test list data (empty array - no preset tests)
    const sampleTests = [];

    // Sample test report data (empty array - no preset reports)
    const sampleTestReports = [];

    // Load sample tests
    function loadSampleTests() {
      staffUtils.showModal('No preset tests available. Please add tests through the lab technician dashboard using the "Add New Test" button.', 'info');
    }

    // Load sample test reports
    function loadSampleTestReports() {
      staffUtils.showModal('No preset test reports available. Please add test reports through the lab technician dashboard using the "Add New Test Report" button.', 'info');
    }

    // Clear all data
    function clearAllData() {
      staffUtils.confirmAction('Are you sure you want to clear all data?', function() {
        localStorage.removeItem(TEST_LIST_DATA_KEY);
        localStorage.removeItem(TEST_REPORT_DATA_KEY);
        updateStatus();
        staffUtils.showModal('All data cleared successfully!', 'success');
      });
    }

    // Check local storage
    function checkLocalStorage() {
      const tests = staffUtils.loadData(TEST_LIST_DATA_KEY);
      const reports = staffUtils.loadData(TEST_REPORT_DATA_KEY);
      
      console.log('Local Storage Contents:');
      console.log('Tests:', tests);
      console.log('Reports:', reports);
      
      staffUtils.showModal(`Local Storage Check Complete!\n\nTests: ${tests ? tests.length : 0}\nReports: ${reports ? reports.length : 0}`, 'info');
    }

    // Update status display
    function updateStatus() {
      const tests = staffUtils.loadData(TEST_LIST_DATA_KEY);
      const reports = staffUtils.loadData(TEST_REPORT_DATA_KEY);
      
      document.getElementById('testListCount').textContent = 
        tests ? `${tests.length} tests loaded` : 'No data loaded';
      document.getElementById('testReportCount').textContent = 
        reports ? `${reports.length} reports loaded` : 'No data loaded';
    }

    // Test functions
    function testTestListCRUD() {
      const tests = staffUtils.loadData(TEST_LIST_DATA_KEY);
      if (!tests || tests.length === 0) {
        staffUtils.showModal('No test data found. Please add tests through the dashboard first.', 'error');
        return;
      }
      
      // Test CRUD operations
      const testTest = {
        id: 'TEST_CRUD001',
        testName: 'Test CRUD Test',
        category: 'other',
        price: 100.00,
        duration: 1,
        description: 'Test test for CRUD testing',
        status: 'active',
        createdAt: new Date().toISOString()
      };
      
      // Add
      tests.push(testTest);
      staffUtils.saveData(tests, TEST_LIST_DATA_KEY);
      
      // Update
      const updatedTests = tests.map(t => 
        t.id === 'TEST_CRUD001' ? {...t, price: 150.00} : t
      );
      staffUtils.saveData(updatedTests, TEST_LIST_DATA_KEY);
      
      // Delete
      const finalTests = updatedTests.filter(t => t.id !== 'TEST_CRUD001');
      staffUtils.saveData(finalTests, TEST_LIST_DATA_KEY);
      
      updateStatus();
      staffUtils.showModal('Test List CRUD test completed successfully!', 'success');
    }

    function testTestReportCRUD() {
      const reports = staffUtils.loadData(TEST_REPORT_DATA_KEY);
      if (!reports || reports.length === 0) {
        staffUtils.showModal('No test report data found. Please add test reports through the dashboard first.', 'error');
        return;
      }
      
      // Test CRUD operations
      const testReport = {
        id: 'REP_CRUD001',
        patientId: 'PAT_TEST',
        patientName: 'Test Patient',
        doctorName: 'Dr. Test',
        testDate: new Date().toISOString().split('T')[0],
        testName: 'Test Report CRUD',
        status: 'pending',
        highRange: '100',
        lowRange: '50',
        actualReading: '75',
        observedReading: '75',
        notes: 'Test report for CRUD testing',
        createdAt: new Date().toISOString()
      };
      
      // Add
      reports.push(testReport);
      staffUtils.saveData(reports, TEST_REPORT_DATA_KEY);
      
      // Update
      const updatedReports = reports.map(r => 
        r.id === 'REP_CRUD001' ? {...r, status: 'completed'} : r
      );
      staffUtils.saveData(updatedReports, TEST_REPORT_DATA_KEY);
      
      // Delete
      const finalReports = updatedReports.filter(r => r.id !== 'REP_CRUD001');
      staffUtils.saveData(finalReports, TEST_REPORT_DATA_KEY);
      
      updateStatus();
      staffUtils.showModal('Test Report CRUD test completed successfully!', 'success');
    }

    function testReportPrinting() {
      const reports = staffUtils.loadData(TEST_REPORT_DATA_KEY);
      if (!reports || reports.length === 0) {
        staffUtils.showModal('No test report data found. Please add test reports through the dashboard first.', 'error');
        return;
      }
      
      const testReport = reports[0];
      const printWindow = window.open('', '_blank');
      
      const reportHTML = `
        <!DOCTYPE html>
        <html>
        <head>
          <title>Test Report - ${testReport.patientName}</title>
          <style>
            body { font-family: Arial, sans-serif; margin: 20px; }
            .test-report-print { max-width: 800px; margin: 0 auto; }
            .report-header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 20px; margin-bottom: 20px; }
            .info-table, .results-table { width: 100%; border-collapse: collapse; margin: 10px 0; }
            .info-table td, .results-table th, .results-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
            .results-table th { background-color: #f5f5f5; }
            .patient-info, .test-results, .test-notes { margin: 20px 0; }
            .report-footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; }
          </style>
        </head>
        <body>
          <div class="test-report-print">
            <div class="report-header">
              <h2>Laboratory Test Report</h2>
              <div class="report-info">
                <p><strong>Report ID:</strong> ${testReport.id}</p>
                <p><strong>Date:</strong> ${testReport.testDate}</p>
                <p><strong>Status:</strong> ${testReport.status}</p>
              </div>
            </div>
            
            <div class="patient-info">
              <h3>Patient Information</h3>
              <table class="info-table">
                <tr>
                  <td><strong>Patient ID:</strong></td>
                  <td>${testReport.patientId}</td>
                  <td><strong>Patient Name:</strong></td>
                  <td>${testReport.patientName}</td>
                </tr>
                <tr>
                  <td><strong>Doctor Name:</strong></td>
                  <td>${testReport.doctorName}</td>
                  <td><strong>Test Name:</strong></td>
                  <td>${testReport.testName}</td>
                </tr>
              </table>
            </div>
            
            <div class="test-results">
              <h3>Test Results</h3>
              <table class="results-table">
                <thead>
                  <tr>
                    <th>Parameter</th>
                    <th>Low Range</th>
                    <th>High Range</th>
                    <th>Actual Reading</th>
                    <th>Observed Reading</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>${testReport.testName}</td>
                    <td>${testReport.lowRange || '-'}</td>
                    <td>${testReport.highRange || '-'}</td>
                    <td>${testReport.actualReading || '-'}</td>
                    <td>${testReport.observedReading || '-'}</td>
                  </tr>
                </tbody>
              </table>
            </div>
            
            ${testReport.notes ? `
              <div class="test-notes">
                <h3>Notes</h3>
                <p>${testReport.notes}</p>
              </div>
            ` : ''}
            
            <div class="report-footer">
              <p><strong>Report Generated:</strong> ${new Date().toLocaleString()}</p>
              <p><strong>Lab Technician:</strong> Lab Technician</p>
            </div>
          </div>
        </body>
        </html>
      `;
      
      printWindow.document.write(reportHTML);
      printWindow.document.close();
      printWindow.focus();
      printWindow.print();
      
      staffUtils.showModal('Test report printing test completed! Check the print dialog.', 'success');
    }

    function exportData() {
      const tests = staffUtils.loadData(TEST_LIST_DATA_KEY);
      const reports = staffUtils.loadData(TEST_REPORT_DATA_KEY);
      
      const exportData = {
        tests: tests || [],
        reports: reports || [],
        exportDate: new Date().toISOString()
      };
      
      const dataStr = JSON.stringify(exportData, null, 2);
      const dataBlob = new Blob([dataStr], {type: 'application/json'});
      
      const link = document.createElement('a');
      link.href = URL.createObjectURL(dataBlob);
      link.download = `labtech_data_${new Date().toISOString().split('T')[0]}.json`;
      link.click();
      
      staffUtils.showModal('Data exported successfully!', 'success');
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      updateStatus();
      console.log('Test Lab Technician Dashboard initialized!');
    });
  </script>

  <style>
    .test-section {
      background: white;
      border-radius: 10px;
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .test-controls {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      margin: 1rem 0;
    }

    .test-status {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
      margin: 1rem 0;
    }

    .status-card {
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 8px;
      border-left: 4px solid #007bff;
    }

    .status-card h3 {
      margin: 0 0 0.5rem 0;
      color: #333;
    }

    .status-card p {
      margin: 0;
      color: #666;
    }

    .features-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1rem;
      margin: 1rem 0;
    }

    .feature-card {
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 8px;
      border-left: 4px solid #28a745;
    }

    .feature-card h3 {
      margin: 0 0 1rem 0;
      color: #333;
    }

    .feature-card ul {
      margin: 0;
      padding-left: 1.5rem;
    }

    .feature-card li {
      margin-bottom: 0.5rem;
      color: #666;
    }

    .test-functions {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      margin: 1rem 0;
    }
  </style>
</body>
</html> 