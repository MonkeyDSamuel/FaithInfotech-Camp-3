<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pharmacist Dashboard Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            background: #f5f5f5;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .result {
            background: #e8f5e8;
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
            border-left: 4px solid #4caf50;
        }
        .error {
            background: #ffebee;
            border-left-color: #f44336;
        }
        .warning {
            background: #fff3cd;
            border-left-color: #ffc107;
        }
        button {
            background: #2196f3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 3px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #1976d2;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        .data-table th, .data-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .data-table th {
            background-color: #f2f2f2;
        }
        .data-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .storage-key {
            font-family: monospace;
            background: #f0f0f0;
            padding: 2px 4px;
            border-radius: 3px;
        }
        .count-badge {
            background: #4caf50;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            margin-left: 5px;
        }
        .status-badge {
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
        }
        .status-active {
            background: #4caf50;
            color: white;
        }
        .status-warning {
            background: #ff9800;
            color: white;
        }
        .status-error {
            background: #f44336;
            color: white;
        }
        .text-danger {
            color: #f44336;
        }
    </style>
</head>
<body>
    <h1>Pharmacist Dashboard Test</h1>
    <p>This page tests the enhanced pharmacist dashboard functionality including medicine CRUD operations and prescription management.</p>

    <div class="test-section">
        <h3>Test 1: Check Local Storage Keys</h3>
        <button onclick="checkStorageKeys()">Check Storage Keys</button>
        <div id="storageKeysResult"></div>
    </div>

    <div class="test-section">
        <h3>Test 2: Medicine Management</h3>
        <button onclick="loadMedicines()">Load Medicines</button>
        <button onclick="addSampleMedicine()">Add Sample Medicine</button>
        <button onclick="clearMedicines()">Clear Medicines</button>
        <div id="medicinesResult"></div>
    </div>

    <div class="test-section">
        <h3>Test 3: Prescription Management</h3>
        <button onclick="loadPrescriptions()">Load Prescriptions</button>
        <button onclick="addSamplePrescription()">Add Sample Prescription</button>
        <button onclick="clearPrescriptions()">Clear Prescriptions</button>
        <div id="prescriptionsResult"></div>
    </div>

    <div class="test-section">
        <h3>Test 4: Medicine CRUD Operations</h3>
        <button onclick="testMedicineCRUD()">Test Medicine CRUD</button>
        <div id="medicineCRUDResult"></div>
    </div>

    <div class="test-section">
        <h3>Test 5: Prescription Status Updates</h3>
        <button onclick="testPrescriptionStatus()">Test Status Updates</button>
        <div id="prescriptionStatusResult"></div>
    </div>

    <div class="test-section">
        <h3>Test 6: Stock Management</h3>
        <button onclick="testStockManagement()">Test Stock Management</button>
        <div id="stockManagementResult"></div>
    </div>

    <script>
        // Storage keys
        const MEDICINE_DATA_KEY = 'hospitalMedicineData';
        const PRESCRIPTION_DATA_KEY = 'hospitalPharmacistData';

        // Load data from local storage
        function loadData(key) {
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : [];
            } catch (error) {
                console.error(`Error loading data from ${key}:`, error);
                return [];
            }
        }

        // Save data to local storage
        function saveData(data, key) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
                return true;
            } catch (error) {
                console.error(`Error saving data to ${key}:`, error);
                return false;
            }
        }

        // Generate ID
        function generateId(prefix) {
            return prefix + Date.now() + Math.random().toString(36).substr(2, 5);
        }

        // Get stock status
        function getStockStatus(quantity) {
            if (quantity <= 0) {
                return '<span class="status-badge status-error">Out of Stock</span>';
            } else if (quantity <= 10) {
                return '<span class="status-badge status-warning">Low Stock</span>';
            } else {
                return '<span class="status-badge status-active">In Stock</span>';
            }
        }

        // Get category name
        function getCategoryName(category) {
            const categoryNames = {
                'antibiotics': 'Antibiotics',
                'painkillers': 'Painkillers',
                'vitamins': 'Vitamins',
                'diabetes': 'Diabetes',
                'cardiac': 'Cardiac',
                'other': 'Other'
            };
            return categoryNames[category] || category;
        }

        function checkStorageKeys() {
            const keys = [
                MEDICINE_DATA_KEY,
                PRESCRIPTION_DATA_KEY
            ];
            
            let result = '<div class="result">';
            result += '<h4>Local Storage Keys Status:</h4>';
            
            keys.forEach(key => {
                const data = loadData(key);
                const count = Array.isArray(data) ? data.length : 0;
                const status = count > 0 ? '✅ Has Data' : '❌ Empty';
                
                result += `<div><span class="storage-key">${key}</span>: ${status} <span class="count-badge">${count} items</span></div>`;
            });
            
            result += '</div>';
            document.getElementById('storageKeysResult').innerHTML = result;
        }

        function loadMedicines() {
            const medicines = loadData(MEDICINE_DATA_KEY);
            
            let result = '<div class="result">';
            result += `<h4>Medicines (${medicines.length} total):</h4>`;
            
            if (medicines.length === 0) {
                result += '<p>No medicines found in local storage.</p>';
            } else {
                result += '<table class="data-table">';
                result += '<tr><th>Name</th><th>Generic Name</th><th>Category</th><th>Quantity</th><th>Dosage</th><th>Expiry Date</th><th>Status</th></tr>';
                
                medicines.forEach(medicine => {
                    const isExpired = new Date(medicine.expiryDate) < new Date();
                    const stockStatus = getStockStatus(medicine.quantity);
                    
                    result += `<tr>
                        <td>${medicine.name}</td>
                        <td>${medicine.genericName}</td>
                        <td>${getCategoryName(medicine.category)}</td>
                        <td>${medicine.quantity}</td>
                        <td>${medicine.dosage}</td>
                        <td class="${isExpired ? 'text-danger' : ''}">${new Date(medicine.expiryDate).toLocaleDateString()}</td>
                        <td>${stockStatus}</td>
                    </tr>`;
                });
                
                result += '</table>';
            }
            
            result += '</div>';
            document.getElementById('medicinesResult').innerHTML = result;
        }

        function loadPrescriptions() {
            const prescriptions = loadData(PRESCRIPTION_DATA_KEY);
            
            let result = '<div class="result">';
            result += `<h4>Prescriptions (${prescriptions.length} total):</h4>`;
            
            if (prescriptions.length === 0) {
                result += '<p>No prescriptions found in local storage.</p>';
            } else {
                result += '<table class="data-table">';
                result += '<tr><th>Patient ID</th><th>Patient Name</th><th>Doctor</th><th>Date</th><th>Status</th><th>Received</th></tr>';
                
                prescriptions.forEach(prescription => {
                    const statusBadge = getStatusBadge(prescription.status);
                    const receivedDate = prescription.receivedAt ? new Date(prescription.receivedAt).toLocaleDateString() : 'N/A';
                    
                    result += `<tr>
                        <td>${prescription.patientId}</td>
                        <td>${prescription.patientName}</td>
                        <td>${prescription.doctorName || 'Unknown Doctor'}</td>
                        <td>${new Date(prescription.date).toLocaleDateString()}</td>
                        <td>${statusBadge}</td>
                        <td>${receivedDate}</td>
                    </tr>`;
                });
                
                result += '</table>';
            }
            
            result += '</div>';
            document.getElementById('prescriptionsResult').innerHTML = result;
        }

        function getStatusBadge(status) {
            const statusClasses = {
                'pending': 'status-warning',
                'in_progress': 'status-active',
                'completed': 'status-active',
                'cancelled': 'status-error'
            };
            
            const className = statusClasses[status] || 'status-warning';
            return `<span class="status-badge ${className}">${status}</span>`;
        }

        function addSampleMedicine() {
            const medicines = loadData(MEDICINE_DATA_KEY);
            
            const sampleMedicine = {
                id: generateId('MED'),
                name: 'Paracetamol 500mg',
                genericName: 'Acetaminophen',
                category: 'painkillers',
                quantity: 100,
                dosage: '500mg',
                expiryDate: new Date(Date.now() + 365 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                price: 5.50,
                manufacturer: 'ABC Pharmaceuticals',
                description: 'Common pain reliever and fever reducer',
                createdBy: 'PH001',
                createdAt: new Date().toISOString()
            };
            
            medicines.push(sampleMedicine);
            saveData(medicines, MEDICINE_DATA_KEY);
            
            document.getElementById('medicinesResult').innerHTML = '<div class="result">✅ Sample medicine added to local storage.</div>';
        }

        function addSamplePrescription() {
            const prescriptions = loadData(PRESCRIPTION_DATA_KEY);
            
            const samplePrescription = {
                id: generateId('PRES'),
                patientId: 'PAT0001',
                patientName: 'John Doe',
                doctorName: 'Dr. Smith',
                date: new Date().toISOString().split('T')[0],
                status: 'pending',
                notes: 'Patient has fever and headache',
                medicines: 'Paracetamol 500mg - 2 tablets every 6 hours',
                receivedAt: new Date().toISOString(),
                source: 'doctor_dashboard'
            };
            
            prescriptions.push(samplePrescription);
            saveData(prescriptions, PRESCRIPTION_DATA_KEY);
            
            document.getElementById('prescriptionsResult').innerHTML = '<div class="result">✅ Sample prescription added to local storage.</div>';
        }

        function clearMedicines() {
            if (confirm('Are you sure you want to clear all medicines?')) {
                localStorage.removeItem(MEDICINE_DATA_KEY);
                document.getElementById('medicinesResult').innerHTML = '<div class="result">✅ Medicines cleared from local storage.</div>';
            }
        }

        function clearPrescriptions() {
            if (confirm('Are you sure you want to clear all prescriptions?')) {
                localStorage.removeItem(PRESCRIPTION_DATA_KEY);
                document.getElementById('prescriptionsResult').innerHTML = '<div class="result">✅ Prescriptions cleared from local storage.</div>';
            }
        }

        function testMedicineCRUD() {
            let result = '<div class="result">';
            result += '<h4>Medicine CRUD Operations Test:</h4>';
            
            // Test Create
            const medicines = loadData(MEDICINE_DATA_KEY);
            const newMedicine = {
                id: generateId('MED'),
                name: 'Test Medicine',
                genericName: 'Test Generic',
                category: 'other',
                quantity: 50,
                dosage: '100mg',
                expiryDate: new Date(Date.now() + 180 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                price: 10.00,
                manufacturer: 'Test Pharma',
                description: 'Test medicine for CRUD operations',
                createdBy: 'PH001',
                createdAt: new Date().toISOString()
            };
            
            medicines.push(newMedicine);
            saveData(medicines, MEDICINE_DATA_KEY);
            result += '<p>✅ Create: Medicine added successfully</p>';
            
            // Test Read
            const loadedMedicines = loadData(MEDICINE_DATA_KEY);
            const foundMedicine = loadedMedicines.find(m => m.id === newMedicine.id);
            if (foundMedicine) {
                result += '<p>✅ Read: Medicine retrieved successfully</p>';
            } else {
                result += '<p>❌ Read: Medicine not found</p>';
            }
            
            // Test Update
            if (foundMedicine) {
                foundMedicine.quantity = 75;
                foundMedicine.updatedAt = new Date().toISOString();
                saveData(loadedMedicines, MEDICINE_DATA_KEY);
                result += '<p>✅ Update: Medicine quantity updated successfully</p>';
            }
            
            // Test Delete
            const updatedMedicines = loadData(MEDICINE_DATA_KEY);
            const medicineIndex = updatedMedicines.findIndex(m => m.id === newMedicine.id);
            if (medicineIndex !== -1) {
                updatedMedicines.splice(medicineIndex, 1);
                saveData(updatedMedicines, MEDICINE_DATA_KEY);
                result += '<p>✅ Delete: Medicine deleted successfully</p>';
            }
            
            result += '<p><strong>All CRUD operations completed successfully!</strong></p>';
            result += '</div>';
            
            document.getElementById('medicineCRUDResult').innerHTML = result;
        }

        function testPrescriptionStatus() {
            let result = '<div class="result">';
            result += '<h4>Prescription Status Update Test:</h4>';
            
            const prescriptions = loadData(PRESCRIPTION_DATA_KEY);
            if (prescriptions.length === 0) {
                result += '<p>❌ No prescriptions found. Please add a sample prescription first.</p>';
            } else {
                const prescription = prescriptions[0];
                const originalStatus = prescription.status;
                
                // Test status update
                prescription.status = 'in_progress';
                prescription.updatedAt = new Date().toISOString();
                prescription.updatedBy = 'PH001';
                
                saveData(prescriptions, PRESCRIPTION_DATA_KEY);
                result += `<p>✅ Status updated from "${originalStatus}" to "${prescription.status}"</p>`;
                
                // Test multiple status updates
                const statuses = ['pending', 'in_progress', 'completed', 'cancelled'];
                statuses.forEach((status, index) => {
                    setTimeout(() => {
                        prescription.status = status;
                        prescription.updatedAt = new Date().toISOString();
                        saveData(prescriptions, PRESCRIPTION_DATA_KEY);
                        result += `<p>✅ Status cycle ${index + 1}: Updated to "${status}"</p>`;
                    }, index * 1000);
                });
                
                result += '<p><strong>Status update functionality working correctly!</strong></p>';
            }
            
            result += '</div>';
            document.getElementById('prescriptionStatusResult').innerHTML = result;
        }

        function testStockManagement() {
            let result = '<div class="result">';
            result += '<h4>Stock Management Test:</h4>';
            
            const medicines = loadData(MEDICINE_DATA_KEY);
            if (medicines.length === 0) {
                result += '<p>❌ No medicines found. Please add a sample medicine first.</p>';
            } else {
                const medicine = medicines[0];
                const originalQuantity = medicine.quantity;
                
                // Test quantity reduction
                const reduceQuantity = 10;
                if (medicine.quantity >= reduceQuantity) {
                    medicine.quantity -= reduceQuantity;
                    medicine.updatedAt = new Date().toISOString();
                    medicine.updatedBy = 'PH001';
                    
                    // Add reduction history
                    if (!medicine.reductionHistory) {
                        medicine.reductionHistory = [];
                    }
                    medicine.reductionHistory.push({
                        date: new Date().toISOString(),
                        quantity: reduceQuantity,
                        reason: 'dispensed',
                        notes: 'Test reduction',
                        reducedBy: 'PH001'
                    });
                    
                    saveData(medicines, MEDICINE_DATA_KEY);
                    result += `<p>✅ Quantity reduced from ${originalQuantity} to ${medicine.quantity}</p>`;
                    result += `<p>✅ Reduction history recorded</p>`;
                    
                    // Test stock status
                    const stockStatus = getStockStatus(medicine.quantity);
                    result += `<p>✅ Stock status: ${stockStatus}</p>`;
                } else {
                    result += '<p>❌ Cannot reduce quantity: insufficient stock</p>';
                }
                
                result += '<p><strong>Stock management functionality working correctly!</strong></p>';
            }
            
            result += '</div>';
            document.getElementById('stockManagementResult').innerHTML = result;
        }

        // Auto-check storage keys on page load
        window.addEventListener('load', function() {
            checkStorageKeys();
        });
    </script>
</body>
</html> 